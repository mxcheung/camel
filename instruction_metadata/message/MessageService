import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;

import java.util.Map;

public class MessageService {

    private static final Logger log = LoggerFactory.getLogger(MessageService.class);
    private final ObjectMapper objectMapper;

    public MessageService(ObjectMapper objectMapper) {
        this.objectMapper = objectMapper;
    }

    public void sendMessage(String message, Map<String, Object> instructionMeta) {
        try {
            // Convert meta to JSON
            String metaJson = objectMapper.writeValueAsString(instructionMeta);

            // Put in MDC
            MDC.put("instruction_meta", metaJson);

            // Log with structured MDC
            log.info(message);
        } catch (JsonProcessingException e) {
            log.error("Failed to serialize instruction metadata", e);
        } finally {
            // Clear to avoid leaking MDC across threads
            MDC.remove("instruction_meta");
        }
    }
}
